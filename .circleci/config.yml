version: 2.1

orbs:
  dmz: eddiewebb/dmz@volatile

jobs:
  build: #this job uses a *public* key file within the repo to be explicitly trusted
    docker:
      - image: circleci/node:10
    steps:
      - checkout
      - dmz/open_tunnel:
          local_port: "9001"
          target_host: artifactory.corp.mendeley.com
          target_port: "443"
          bastion_user: circleci
          bastion_host: bastion-elb-staging-582697253.eu-west-1.elb.amazonaws.com
         # bastion_public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/4p1DleRRDRzRe1ayBKuUz7QID9wli8pDvgeVOn4bAMNkKZ3q0Lq97ffln54ti2qvUqZaGxTHKnrliKsbzhRdJAe5PuSFzT1cCrMxTG4zo4VsOKiUNy4yv/mY0z+Etx/9rdVjJk6kABfXKT/iAGpky81Sd0SQxWlz39alJEdjBESP49uqNKrFMCT1zUmdlmnBUHTi0a+uySase2vTRiNIXyezxS2hqUHThJ6MoGtWxlz0J6VQ9LUj78J3Tncnx/vSqkALPEPn+w8sawmB87qZ5LNbQyj8Xg65kjdmGgVT0mlyzIxq8vwS04F6VIk/CLvk0pIS/tvE0Eh30PTi2dqd'
   # and simply confirm that accessing local port resolves the target (in this case an HTTP server)
      - run: curl localhost:9001


workflows:
  test_all:
    jobs:
    - build
